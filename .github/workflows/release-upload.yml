name: Upload Release Asset

on:
  workflow_run:
    workflows: ["Build project"]
    types:
      - completed

permissions:
  contents: write

jobs:
  upload_to_release:
    runs-on: ubuntu-latest
    # 核心修复：只有成功完成，且触发源是一个 Tag 时才运行 (排除 main 分支推送)
    # 在 workflow_run 事件中，head_branch 在标签推送时就是标签名
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push'

    steps:
      - name: Prepare Names
        id: vars
        run: |
          # 获取触发 Build 的分支或标签名
          TAG_NAME=${{ github.event.workflow_run.head_branch }}
          REPO_NAME=${{ github.event.repository.name }}
          
          # 必须与 Build project 中的命名逻辑完全一致
          ARTIFACT_NAME="${REPO_NAME}-${TAG_NAME}"
          
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "zip_name=${ARTIFACT_NAME}.zip" >> $GITHUB_OUTPUT

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.vars.outputs.artifact_name }}
          path: ./release-files
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Archive files
        run: |
          cd ./release-files
          zip -r ../${{ steps.vars.outputs.zip_name }} .

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.event.workflow_run.head_branch, 'v') # 可选：确保只有 v 开头的标签才上传
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          files: ${{ steps.vars.outputs.zip_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
