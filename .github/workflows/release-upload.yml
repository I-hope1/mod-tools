name: Upload Release Asset

on:
  workflow_run:
    workflows: ["Build project"] # 确保这与 build 工作流的 name 字段完全一致
    types:
      - completed

permissions:
  contents: write

jobs:
  upload_to_release:
    runs-on: ubuntu-latest
    # 仅在成功完成且有关联标签时运行
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch != null
    
    steps:
      - name: Get Tag Name
        id: vars
        run: |
          # 在 workflow_run 中，head_branch 通常就是 tag 名 (例如 v1.0.0)
          TAG_NAME=${{ github.event.workflow_run.head_branch }}
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          
          # 设置文件名
          REPO_NAME=${{ github.event.repository.name }}
          echo "artifact_name=${REPO_NAME}-${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "zip_name=${REPO_NAME}-${TAG_NAME}.zip" >> $GITHUB_OUTPUT

      - name: Download artifact from 'Build project'
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.vars.outputs.artifact_name }}
          path: ./release-files
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Archive files into Zip
        # 将下载的内容重新打包，因为 download-artifact 会解压内容
        run: |
          cd ./release-files
          zip -r ../${{ steps.vars.outputs.zip_name }} .
          cd ..

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          files: ${{ steps.vars.outputs.zip_name }}
          # 如果 Release 还没创建，它可以根据 tag 自动创建一个草稿或正式发布
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug Info
        if: failure()
        run: |
          echo "Triggering branch/tag: ${{ github.event.workflow_run.head_branch }}"
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
